const cron = require("node-cron");
const { MessageMedia } = require("whatsapp-web.js");
const { autoGeneratedText } = require("./messageTemplates");
const {
  ourGroupId,
  goodMorningMessage,
  goodNightMessage,
  devmechsGroupId,
  me,
} = require("./messageTemplates");
const sendMessageToGroup = async (client, message) => {
  const grpchat = await client.getChatById(ourGroupId);
  let text = `${message}\n`;
  let mentions = [];
  console.log(grpchat);
  for (let participant of grpchat.participants) {
    const contact = await client.getContactById(participant.id._serialized);
    mentions.push(contact);
    text += `@${participant.id.user} `;
  }
  await grpchat.sendMessage(text, { mentions });
};

const initCronJobs = (client) => {
  //send message after every hour
  cron.schedule(
    "0 20 * * 3",
    () => {
      console.log("wednesday");
      const media = MessageMedia.fromFilePath("./already_wednesday.jpeg");

      client.sendMessage(devmechsGroupId, media, {
        caption: autoGeneratedText,
      });
      client.sendMessage(me, media, {
        caption: autoGeneratedText,
      });
    },
    {
      timezone: "Asia/Karachi",
    }
  );
  cron.schedule("0 */1 * * *", () => {
    client.sendMessage(me, "Your bot is running!");
  });
  cron.schedule(
    "0 0 * * *",
    () => {
      sendMessageToGroup(client, goodNightMessage);
      console.log("hello");
    },
    {
      timezone: "Asia/Karachi",
    }
  );
  cron.schedule(
    "0 10 * * *",
    () => sendMessageToGroup(client, goodMorningMessage),
    {
      timezone: "Asia/Karachi",
    }
  );
};

module.exports = initCronJobs;
